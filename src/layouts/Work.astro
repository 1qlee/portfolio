---
import { getCollection, type CollectionEntry } from "astro:content";
import { getImage } from "astro:assets";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.tsx";
import { STYLE_CONTAINER } from "../data/data_styles";
import WorkLink from "../components/WorkLink.tsx";
import Background from "../components/Background.tsx";
import WorkImg from "../components/WorkImg.tsx";
// Define the type for the props expected by this component
interface Props {
  workEntry: CollectionEntry<"work">;
}

const { workEntry } = Astro.props;

// Destructure the data, ensuring 'src' is the ImageMetadata object
const {
  title,
  description,
  color,
  year,
  client,
  role,
  tags,
  index,
  link,
  src, // This `src` MUST be the ImageMetadata object.
} = workEntry.data;

// --- Your existing variables from the page component ---
const allWorkEntries = await getCollection("work"); // Assuming you still need this here
const prevWorkEntry = allWorkEntries.find(
  (work) => work.data.index === index - 1,
);
const nextWorkEntry = allWorkEntries.find(
  (work) => work.data.index === index + 1,
);
const boxClass = "border p-2 border-b-[0px]";
const pTextClass = "text-clamp-sm col-span-4";
const h3TextClass = "uppercase text-xs font-bold mb-1";
const anim = {
  old: {
    name: "slideOut",
    duration: "0.25s",
    easing: "ease-in-out",
    direction: "reverse",
  },
  new: {
    name: "slideIn",
    duration: "0.25s",
    delay: "0.5s",
    easing: "ease-in-out",
  },
};
const slideDown = {
  old: {
    name: "slideDown",
    duration: "0.25s",
    easing: "ease-in-out",
    direction: "reverse",
  },
  new: {
    name: "slideDown",
    duration: "0.25s",
    delay: "0.5s",
    easing: "ease-in-out",
  },
};

const customTransition = {
  forwards: anim,
  backwards: anim,
};
const slideDownAnim = {
  forwards: slideDown,
  backwards: slideDown,
};
// --- End of your existing variables ---

// --- IMAGE OPTIMIZATION LOGIC ---
// Define the widths you want for your srcset
const imageWidths = [320, 640, 1024, 1440, 1920]; // Example widths

// Log the type of `src` to confirm it's an object (ImageMetadata)
console.log("Type of workEntry.data.src:", typeof src);
console.log("workEntry.data.src object:", src); // Inspect its content

// Generate optimized images for each width
const optimizedImages = await Promise.all(
  imageWidths.map(async (width) => {
    return await getImage({
      src: src, // <--- This 'src' MUST be the ImageMetadata object from `workEntry.data.src`
      width: width,
      formats: ["webp", "jpeg"], // Consider what formats you want
      quality: 80, // Adjust quality as needed
    });
  }),
);

// Construct the srcset string
const generatedSrcSet = optimizedImages
  .map((img) => `${img.src} ${img.attributes.width}w`)
  .join(", ");

// Get the default/largest image src for the 'src' prop
const mainImage = optimizedImages[optimizedImages.length - 1]; // Use the largest generated image
const mainImageSrc = mainImage.src;
const mainImageWidth = mainImage.attributes.width; // Access width from .attributes
const mainImageHeight = mainImage.attributes.height; // Access height from .attributes

// --- END IMAGE OPTIMIZATION LOGIC ---
---

<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
  </head>

  <body>
    <Header transition:persist transition:name="header" client:load />
    <Background color={color} transition:persist client:load />
    <main class="w-fit pt-8">
      <div class={STYLE_CONTAINER}>
        <div class="relative h-min-screen gap-y-4 pb-2">
          <div class="flex justify-between items-center mb-8 gap-4">
            <div class="grow overflow-hidden">
              <h1
                class="w-full block text-clamp-lg"
                transition:animate={customTransition}
              >
                {title}
              </h1>
            </div>
            <div class="flex gap-2">
              {
                prevWorkEntry && (
                  <WorkLink direction="prev" slug={prevWorkEntry.data.slug} />
                )
              }
              {
                nextWorkEntry && (
                  <WorkLink direction="next" slug={nextWorkEntry.data.slug} />
                )
              }
            </div>
          </div>
          <div class="grid grid-cols-12 gap-8">
            <div
              class="col-span-full md:col-span-4"
              transition:animate={slideDownAnim}
            >
              <div class={boxClass}>
                <a
                  href={link}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="block whitespace-nowrap py-2 px-4 border rounded-full text-center text-clamp-sm"
                >
                  Visit Website
                </a>
              </div>
              <div class={boxClass}>
                <h3 class={h3TextClass}>Year</h3>
                <p class={pTextClass}>{year}</p>
              </div>
              {
                client && (
                  <div class={boxClass}>
                    <h3 class={h3TextClass}>Client</h3>
                    <p class={pTextClass}>{client}</p>
                  </div>
                )
              }
              <div class={boxClass}>
                <h3 class={h3TextClass}>Role</h3>
                <p class={pTextClass}>{role}</p>
              </div>
              <div class={boxClass}>
                <h3 class={h3TextClass}>Services</h3>
                {
                  tags.map((tag, index) => (
                    <span class={pTextClass}>
                      {tag + (index + 1 !== tags.length ? ", " : "")}
                    </span>
                  ))
                }
              </div>
              <div class="border p-2">
                <h3 class={h3TextClass}>Description</h3>
                <slot />
              </div>
            </div>
            <div class="col-span-full md:col-span-8">
              <div
                class="border overflow-y-hidden"
                transition:animate={customTransition}
              >
                <WorkImg
                  client:load
                  data={{
                    src: mainImageSrc,
                    srcSet: generatedSrcSet,
                    alt: description,
                  }}
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
